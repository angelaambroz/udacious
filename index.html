<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <title>Tanzania: 2015 Constitutional referendum</title>
    <style>
/* To do. */

    </style>
</head>

<body>

<script>

"use strict";

var w = 800,
	h = 500,
	margins = 10,
	layout_gravity = -0.01,
	damper = 0.09,
	nodes = [],
	radius = 2,
	obs;

var center = { x: w / 2, y: h / 2 };

var ref_centers = {
	"Vote for": { x: w/3 , y: h/2 },
	"Vote against": { x: 2*(w/3), y: h/2 },
}; 

var force = d3.layout.force();

var svg = d3.select("body")
	.append("svg")
	.attr("width", w - margins)
	.attr("height", h - margins);

function charge(d) {
	return -Math.pow(radius, 2.0) / 5;
};


function move_towards_center(alpha) {
	debugger;
	return function(d) {
	d.x = d.x + (center.x - d.x) * (damper + 0.02) * alpha;
	d.y = d.y + (center.y - d.y) * (damper + 0.02) * alpha;
	};
};

function move_towards_vote(alpha) {
	return function(d) {
		var target = ref_centers[d.vote];
		d.x = d.x + (target.x - d.x) * (damper + 0.05) * alpha;
		d.y = d.y + (target.y - d.y) * (damper + 0.05) * alpha;
		};
}

function voting() {
	force.start()
		.on("tick", function(e) {
		candidates.each(move_towards_sex(e.alpha))
			.attr("transform", function(d, i) {
				return "translate(" + d.x + "," + d.y + ")";
		});
	});
}

function nodify(d) {
	var node = {
		id: +d.uhn,
		draft: d.q4_2015,
		vote: d.q12_2015,
		sex: d.gender_2015,
		urban: d.urban_2015
	};
	nodes.push(node);
};


function viz(data) {

	//Initializing the d3 force layout.
	force.gravity(layout_gravity)
		.charge(charge)
		.friction(0.9)
		.nodes(nodes)
		.size([w - margins, h - margins]);

	//This is where the callback error is happening
	obs = svg.selectAll("circle")
		.data(nodes)
		.enter()
		.append("circle")
		.attr("r", radius)
		.style("fill", function(d) {
			if (d.sex=="Female") { return "pink"; }
			else { return "blue"; }
		})
		.style("stroke-width", "1px")
		.style("stroke", "black")
		.style("opacity", 0.8) 
		.attr("id", function(d) { return "obs_" + d.id; })
		.classed("obs", true)
		.call(force.drag);

	force.on("tick", function(e) {
			obs.each(move_towards_center(e.alpha))
			.attr("transform", function(d, i) {
				return "translate(" + d.x + "," + d.y + ")";
				})
			})
		.start();


	//d3.select(window).on("click", voting());

	debugger;


}; //end viz function



//Better organization: putting everything into above functions
d3.csv("udacity.csv", nodify, viz)


</script>

</body>
</head>
</html>
