<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <link href='http://fonts.googleapis.com/css?family=Josefin+Slab:400,300,600' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:300' rel='stylesheet' type='text/css'>
  <title>katiba</title>
    <style>

@font-face {
    font-family: "Essays1743";
    src: url(Essays1743-Italic.ttf);
}

.header {
	position: absolute;
	top: 20px;
	left: 50px;
}

.header h2 {
 	font: 600 24px "Josefin Slab", serif;
 }

.header h4 {
	font: 400 14px "Josefin Slab", serif;
}


.buttons {
	position: absolute;
	left: 50px;
	font: 300 14px "Open Sans", sans-serif;
	width: 100px;
	padding: 0px 15px;
	background-color: #E6E6E6;
}

.buttons:hover{
	cursor: pointer;
}


#draft {
	top: 150px;
}

#vote {
	top: 250px;
}

.label {
	position: absolute;
	width: 150px;
	height: auto;
	background-color: none;
	pointer-events: none;
	font: 300 14px "Essays1743", serif;
}

.hidden {
	display: none;
}



    </style>
</head>

<body>

<div class="header"><h2>Tanzania's upcoming constitutional referendum</h2>
<h4>A data visualization written in <a href="http://www.d3js.org" target="_blank">D3.js</a> by <a href="http://www.angelaambroz.com" target="_blank">Angela Ambroz</a> for <a href="http://www.twaweza.org" target="_blank">Twaweza</a>.</h4></div>

	<div class="buttons" id="draft"><p>Which draft do people prefer?</p></div>
	<div class="buttons" id="vote"><p>How will people vote in the constitutional referendum?</p></div>
	
	<div id="yea" class="label votes hidden" style="left: 360px; top:350px">YEA</div>
	<div id="nay" class="label votes hidden" style="left: 734px; top:350px">NAY</div>

	<div id="CRC" class="label drafts hidden" style="left: 600px; top:150px">The draft by the Constitutional Review Commission</div>
	<div id="final" class="label drafts hidden" style="left: 600px; top:400px">The second, and final, draft</div>

<script>

"use strict";

var w = 1000,
	h = 500,
	margins = 10,
	layout_gravity = -0.01,
	damper = 0.09,
	nodes = [],
	radius = 2,
	obs,
	girl_color = "rgb(255, 204, 255)",
	boy_color="rgb(153, 204, 255)",
	userSelection,
	test;

var center = { x: w / 2, y: h / 2 };

var ref_centers = {
	"Vote for": { x: w/3+50 , y: h/2 },
	"Vote against": { x: 2*(w/3)+50, y: h/2 },
	"Not sure": { x: 1.5*w, y: h },
	"Don't Know": { x: 1.5*w, y: h },
	"No Response": { x: 1.5*w, y: h },
	"None": { x: 1.5*w, y: h },
	"Refused to Answer": { x: 1.5*w, y: h },
	"I am not going to vote": { x: 1.5*w, y: h },
	"CRC draft": { x: w/2, y: h/4 + 60 },
	"Final draft": { x: w/2, y: 3*h/4-20 }
}; 

var force = d3.layout.force();

var svg = d3.select("body")
	.append("svg")
	.attr("width", w - margins)
	.attr("height", h - margins);


var caption = d3.select("svg")
	.append("text")
	.attr("class", "caption")


function charge(d) {
	return -Math.pow(radius, 2.0) / 5;
};


function move_towards_center(alpha) {
	return function(d) {
	d.x = d.x + (center.x - d.x) * (damper + 0.02) * alpha;
	d.y = d.y + (center.y - d.y) * (damper + 0.02) * alpha;
	};
};

function move_towards_vote(alpha) {
	return function(d) {
		var target = ref_centers[d[userSelection]];
		d.x = d.x + (target.x - d.x) * (damper + 0.05) * alpha;
		d.y = d.y + (target.y - d.y) * (damper + 0.05) * alpha;
		};
}

function nodify(d) {
	var node = {
		id: +d.uhn,
		draft: d.q4_2015,
		vote: d.q12_2015,
		sex: d.gender_2015,
		urban: d.urban_2015
	};
	nodes.push(node);
};

function update(d){

	userSelection = this.id;

	d3.selectAll(".label").classed("hidden", true);

	if(userSelection=="vote") { d3.selectAll(".votes").classed("hidden", false); }
	else if(userSelection=="draft") { d3.selectAll(".drafts").classed("hidden", false); }

	force.on("tick", function(e) {
		obs.each(move_towards_vote(e.alpha))
		.attr("transform", function(d, i) {
			return "translate(" + d.x + "," + d.y + ")";
			})
		})
	.start();
}


function viz(data) {

	//Initializing the d3 force layout.
	force.gravity(layout_gravity)
		.charge(charge)
		.friction(0.9)
		.nodes(nodes)
		.size([w - margins, h - margins]);

	//This is where the callback error is happening
	obs = svg.selectAll("circle")
		.data(nodes)
		.enter()
		.append("circle")
		.attr("r", radius)
		.style("fill", function(d) {
			if (d.sex=="Female") { return girl_color; }
			else { return boy_color; }
		})
		.style("stroke-width", "1px")
		.style("stroke", function(d) {
			if (d.sex=="Female") { return d3.rgb(girl_color).darker; }
			else { return d3.rgb(boy_color).darker; }
		})
		.style("opacity", 0.8) 
		.attr("id", function(d) { return "obs_" + d.id; })
		.classed("obs", true)
		.call(force.drag);

	force.on("tick", function(e) {
			obs.each(move_towards_center(e.alpha))
			.attr("transform", function(d, i) {
				return "translate(" + d.x + "," + d.y + ")";
				})
			})
		.start();

}; //end viz function

//Better organization: putting everything into above functions
d3.csv("udacity.csv", nodify, viz)

//Update outside of viz function?
d3.selectAll(".buttons").on("click", update);


</script>

</body>
</head>
</html>
