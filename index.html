<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <link href='http://fonts.googleapis.com/css?family=Josefin+Slab:400,300,600' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans:300' rel='stylesheet' type='text/css'>
  <title>katiba</title>
    <style>

@font-face {
    font-family: "Essays1743";
    src: url(Essays1743-Italic.ttf);
}

.header {
	position: absolute;
	top: 20px;
	left: 50px;
}

.header h2 {
 	font: 600 24px "Josefin Slab", serif;
 }

.header h4 {
	font: 400 14px "Josefin Slab", serif;
}


.buttons {
	position: absolute;
	left: 50px;
	font: 300 14px "Open Sans", sans-serif;
	width: 100px;
	padding: 0px 15px;
	background-color: #E6E6E6;
}

.buttons:hover,#reset:hover,#rural-urban:hover{
	cursor: pointer;
}


#draft {
	top: 150px;
}

#vote {
	top: 250px;
}

.label {
	position: absolute;
	width: 150px;
	height: auto;
	background-color: none;
	pointer-events: none;
	font: 300 18px "Essays1743", serif;
}

.label p {
	margin: 0px;
}

.hidden {
	display: none;
}

.number {
	font: 300 14px "Open Sans", sans-serif;
	text-align: center;
}

.legend, #rural-urban {
	font: 300 10px "Opens Sans", sans-serif;
}

#reset {
	font: 400 20px "Josefin Slab", sans-serif;
}

.blurb {
	position: absolute;
	font: 300 12px "Opens Sans", sans-serif;;
}

.bottom {
	width: 500px;
	height: auto;
	left: 200px;
	top: 450px;
}

.right {
	width: 280px;
	height: auto;
	left: 780px;
	top: 200px;
}



    </style>
</head>

<body>

<div class="header"><h2>Tanzania's upcoming constitutional referendum</h2>
<h4>A data visualization written in <a href="http://www.d3js.org" target="_blank">D3.js</a>.</h4></div>

	<div class="buttons" id="draft"><p>Which draft do people prefer?</p></div>
	<div class="buttons" id="vote"><p>How will people vote in the constitutional referendum?</p></div>
	
	<div id="yea" class="label votes hidden" style="left: 360px; top:350px"><p>YEA</p><p><span class="number">52%</span></p></div>
	<div id="nay" class="label votes hidden" style="left: 734px; top:350px"><p>NAY</p><p><span class="number">26%</span></p></div>

	<div id="CRC" class="label drafts hidden" style="left: 600px; top:130px"><p>The draft by the Constitutional Review Commission</p><p><span class="number">41%</span></p></div>
	<div id="final" class="label drafts hidden" style="left: 600px; top:370px"><p>The second,  final draft</p><p><span class="number">39%</span></p></div>

	<div class="blurb hidden bottom" id="intro">
		<p>
		Imagine this is all of Tanzania. Actually, it's 1,399 Tanzanians, randomly selected from around the country. But, for all intents and purposes, this blob of pink and blue dots <em><a href="https://en.wikipedia.org/wiki/Sample_%28statistics%29" target="_blank">represents</a></em> the entire country. <a href="http://www.twaweza.org" target="_blank">Twaweza</a>, through its <a href="http://twaweza.org/go/sauti-za-wananchi-english" target="_blank">Sauti za Wananchi</a> (<em>Citizen's Voice</em>) initiative, calls these randomly-selected citizens every month and asks them about their lives.
		</p>
		<p>In January 2015, they were asked about the new draft constitution, and its upcoming referendum scheduled for April 2015.</p>
	</div>

	<div class="blurb hidden bottom" id="vote-text">
		<p>
		A referendum on the new draft constitution has been scheduled for April 2015 for some time - but is the country ready? A coalition of opposition parties, Ukawa, has called on its supporters to boycott the process. While it is unclear how many people will follow through with this, quite a few (22%) are still undecided.</p> 

		<p>The National Electoral Commission's plan to register all 25,000,000 voting-age citizens with a biometric voter identification is woefully behind schedule, <a href="http://mtega.com/2015/03/is-there-still-time-for-nec-to-complete-biometric-voter-registration-for-tanzanias-constitution-referendum/" target="_blank">with some analysts estimating the earliest date they would be ready would be April 25</a>. 
		</p>
	</div>

	<div class="blurb hidden right" id="draft-considerations">
		<p>Certain key issues have been removed or watered down between the original draft constitution and the second draft (which is the current, and final, one). While the CRC draft was prepared by the Constitutional Review Commission, the second draft was prepared by the Constituent Assembly - made up of the ruling party, opposition parties (who later formed a coalition and walked out), and stakeholders from civil society. </p>
		<p>What changed between drafts? The clause which allowed underperforming Members of Parliament to be ousted by their constituents has been removed. Transparency and accountability measures have been removed. And, perhaps most contentiously, the three-government proposal (Zanzibar, Tanganyika, and a union government) is gone.</p>
	</div>


<script>

"use strict";

var w = 1000,
	h = 500,
	margins = 10,
	layout_gravity = -0.01,
	damper = 0.09,
	nodes = [],
	radius = 2,
	toggle = false,
	obs,
	girl_color = "rgb(255, 204, 255)",
	boy_color="rgb(153, 204, 255)",
	userSelection;

var center = { x: w / 2, y: h / 2 };

var ref_centers = {
	"Vote for": { x: w/3+50 , y: h/2 },
	"Vote against": { x: 2*(w/3)+50, y: h/2 },
	"Not sure": { x: 1.5*w, y: h },
	"Don't Know": { x: 1.5*w, y: h },
	"No Response": { x: 1.5*w, y: h },
	"None": { x: 1.5*w, y: h },
	"Refused to Answer": { x: 1.5*w, y: h },
	"I am not going to vote": { x: 1.5*w, y: h },
	"CRC draft": { x: w/2, y: h/4 + 60 },
	"Final draft": { x: w/2, y: 3*h/4-20 }
}; 

var legend_info = [
	{ text: "1 male respondent", color: boy_color },
	{ text: "1 female respondent", color: girl_color },
	{ text: "Urban", color: "white" }
];

var force = d3.layout.force();

var svg = d3.select("body")
	.append("svg")
	.attr("width", w - margins)
	.attr("height", h - margins);


//Various buttons, legends, and so on
var reset = svg.append("g")
	.attr("id", "reset");

reset.append("rect")
	.attr("width", "60px")
	.attr("height", "25px")
	.attr("fill", "none")
	.attr("stroke", "gray")
	.attr("stroke-dasharray", "5,5")
	.attr("x", "50px")
	.attr("y", "375px");

reset.append("text")
	.attr("x", "62px")
	.attr("y", "393px")
	.text("reset");

var legend = svg.selectAll("g.legend")
  .data(legend_info)
  .enter().append("g")
  .attr("class", "legend");

legend.append("circle")
	.attr("r", 2*radius)
	.attr("cx", w-200)
	.attr("cy", function(d, i) { return 100 + (i*10*radius);})
	.style("fill", function(d) { return d.color; })
	.style("stroke", function(d) { 
		if(d.text=="Urban") { return "black"; };
	})
	.style("stroke", function(d) { 
		if(d.text=="Urban") { return "1px"; };
	});

legend.append("text")
	.attr("x", w-190)
	.attr("y", function(d, i ) { return 103 + (i*10*radius);})
	.text(function(d) { return d.text; });

svg.append("text")
	.attr("x", w-190)
	.attr("y", 170)
	.attr("id", "rural-urban")
	.text("Click for rural/urban split.");


//All the functions...

function charge(d) {
	return -Math.pow(radius, 2.0) / 5;
};


function move_towards_center(alpha) {
	return function(d) {
	d.x = d.x + (center.x - d.x) * (damper + 0.02) * alpha;
	d.y = d.y + (center.y - d.y) * (damper + 0.02) * alpha;
	};
};

function move_towards_vote(alpha) {
	return function(d) {
		var target = ref_centers[d[userSelection]];
		d.x = d.x + (target.x - d.x) * (damper + 0.05) * alpha;
		d.y = d.y + (target.y - d.y) * (damper + 0.05) * alpha;
		};
}

function nodify(d) {
	var node = {
		id: +d.uhn,
		draft: d.q4_2015,
		vote: d.q12_2015,
		sex: d.gender_2015,
		urban: d.urban_2015
	};
	nodes.push(node);
};

function update(d) {
	userSelection = this.id;
	d3.selectAll(".label, .blurb").classed("hidden", true);

	if(userSelection=="vote") { d3.selectAll(".votes,#vote-text").classed("hidden", false); }
	else if(userSelection=="draft") { d3.selectAll(".drafts,#draft-considerations").classed("hidden", false); }

	force.on("tick", function(e) {
		obs.each(move_towards_vote(e.alpha))
		.attr("transform", function(d, i) {
			return "translate(" + d.x + "," + d.y + ")";
			})
		})
	.start();
};

function resetting() {
	d3.selectAll(".label, .blurb").classed("hidden", true);
	
	force.on("tick", function(e) {
		obs.each(move_towards_center(e.alpha))
		.attr("transform", function(d, i) {
			return "translate(" + d.x + "," + d.y + ")";
			})
		})
	.start();	
};

function urbanizing(d) {
	console.log(toggle);

	if(toggle===false) {
		obs.style("stroke-width", "1px")
			.style("stroke", function(d) {
				if (d.urban=="Urban") { return "black"; }
				else { return null; }
				});
		toggle = true;
	}
	else {
		obs.style("stroke-width", 0)
			.style("stroke", null);
		toggle = false;
	}

};


function viz(data) {

	d3.select("#intro").classed("hidden", false);

	//Initializing the d3 force layout.
	force.gravity(layout_gravity)
		.charge(charge)
		.friction(0.9)
		.nodes(nodes)
		.size([w - margins, h - margins]);

	//This is where the callback error is happening
	obs = svg.selectAll("circle")
		.data(nodes)
		.enter()
		.append("circle")
		.attr("r", radius)
		.style("fill", function(d) {
			if (d.sex=="Female") { return girl_color; }
			else { return boy_color; }
		})
		.style("opacity", 0.8) 
		.attr("id", function(d) { return "obs_" + d.id; })
		.classed("obs", true);
	
	obs.call(force.drag);

	force.on("tick", function(e) {
			obs.each(move_towards_center(e.alpha))
			.attr("transform", function(d, i) {
				return "translate(" + d.x + "," + d.y + ")";
				})
			})
		.start();

}; //end viz function


//Calling everything

//Better organization: putting everything into above functions
d3.csv("udacity.csv", nodify, viz)

//Update with draft vs. 
d3.selectAll(".buttons").on("click", update);

//Reset
d3.select("#reset").on("click", resetting);

//Rural-urban split
d3.select("#rural-urban").on("click", urbanizing);

</script>

</body>
</head>
</html>
